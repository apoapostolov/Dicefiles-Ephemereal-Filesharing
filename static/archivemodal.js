"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[514],{350(e,t,s){s.d(t,{default:()=>r});var i=s(4440),l=s(3238),n=s(793),o=s(8292);const a=new Set([".jpg",".jpeg",".png",".gif",".webp",".bmp",".avif",".svg"]);function d(e){const t=e.lastIndexOf(".");return t>=0&&a.has(e.slice(t).toLowerCase())}function h(e){const t=[];for(const s of e.files)t.push(s);for(const s of e.children.values())t.push(...h(s));return t}class r extends i.A{constructor(e){const t={id:"download",text:"Download Selected",default:!0};super("archiveviewer",`Archive: ${e.name}`,t,{id:"close",text:"Close",cancel:!0}),this.fileInst=e;const s=(e.href||"").split("/").filter(Boolean),i=s.indexOf("g");this.archiveKey=i>=0?s[i+1]||null:s[s.length-1]||null,this._tree=null,this._allFiles=[],this._format=null,this._folderChecked=new Map,this._fileChecked=new Map,this._folderExpanded=new Map,this._treeEl=null,this._fileListEl=null,this._folderInfoEl=null,this._fileInfoEl=null,this._dlBtn=t.btn,this._holder=null,this._subHolder=null,this._onKeyDown=null,this._searchQuery="",this._imgPopupEl=null,this._imgPopupImgEl=null,this._buildUI(),this._loadListing()}mountInto(e){return this._holder=(0,n.dom)("div",{classes:["av-holder"]}),this._holder.appendChild(this.el),e.appendChild(this._holder),this._onKeyDown=e=>{"Escape"!==e.key||this._subHolder||(e.stopPropagation(),this._unmount(),this.reject(new Error("cancelled")))},document.addEventListener("keydown",this._onKeyDown,!0),this._holder.addEventListener("click",e=>{e.target!==this._holder||this._subHolder||(this._unmount(),this.reject(new Error("cancelled")))}),this.onshown(),this.promise}_unmount(){this._holder&&this._holder.parentElement&&this._holder.parentElement.removeChild(this._holder),this._holder=null,this._onKeyDown&&(document.removeEventListener("keydown",this._onKeyDown,!0),this._onKeyDown=null)}_buildUI(){this.el.classList.add("modal-archiveviewer");const e=(0,n.dom)("div",{classes:["av-layout"]}),t=(0,n.dom)("div",{classes:["av-sidebar"]}),s=(0,n.dom)("div",{classes:["av-sidebar-header"]});this._rootCbEl=(0,n.dom)("input",{attrs:{type:"checkbox",title:"Select / deselect all files"},classes:["av-root-cb"]}),this._rootCbEl.addEventListener("change",()=>{this._folderChecked.set("",this._rootCbEl.checked),this._tree&&this._setChildFolders(this._tree,this._rootCbEl.checked),this._syncRootCheckbox(),this._updateFolderInfo(),this._renderTree(),this._renderFiles()});const i=(0,n.dom)("span",{classes:["av-root-label"],text:"/ [all]"});i.addEventListener("click",()=>this._rootCbEl.click()),this._folderInfoEl=(0,n.dom)("span",{classes:["av-select-info"],text:""});const l=(0,n.dom)("div",{classes:["av-expand-group"]}),o=(0,n.dom)("button",{classes:["av-ctrl-btn"],attrs:{type:"button",title:"Expand all folders"},text:"⊞"});o.addEventListener("click",()=>this._expandAll(!0));const a=(0,n.dom)("button",{classes:["av-ctrl-btn"],attrs:{type:"button",title:"Collapse all folders"},text:"⊟"});a.addEventListener("click",()=>this._expandAll(!1)),l.appendChild(o),l.appendChild(a),s.appendChild(this._rootCbEl),s.appendChild(i),s.appendChild(this._folderInfoEl),s.appendChild(l),t.appendChild(s),this._treeEl=(0,n.dom)("div",{classes:["av-tree"]}),t.appendChild(this._treeEl);const d=(0,n.dom)("div",{classes:["av-filelist"]}),h=(0,n.dom)("div",{classes:["av-filelist-header"]});this._fileInfoEl=(0,n.dom)("span",{classes:["av-select-info"],text:""});const r=(0,n.dom)("button",{classes:["av-ctrl-btn"],attrs:{type:"button",title:"Select all visible files"},text:"Select all"});r.addEventListener("click",()=>this._selectAllFiles(!0));const c=(0,n.dom)("button",{classes:["av-ctrl-btn"],attrs:{type:"button",title:"Clear file selection"},text:"Clear"});c.addEventListener("click",()=>this._selectAllFiles(!1)),h.appendChild(this._fileInfoEl),h.appendChild(r),h.appendChild(c),d.appendChild(h);const p=(0,n.dom)("div",{classes:["av-search-row"]});this._searchEl=(0,n.dom)("input",{attrs:{type:"text",placeholder:"Filter files…",autocomplete:"off",spellcheck:"false"},classes:["av-search"]}),this._searchEl.addEventListener("input",()=>{this._searchQuery=this._searchEl.value.trim().toLowerCase(),this._renderFiles()}),p.appendChild(this._searchEl),d.appendChild(p),this._fileListEl=(0,n.dom)("div",{classes:["av-files"]}),d.appendChild(this._fileListEl),this._imgPopupEl=(0,n.dom)("div",{classes:["av-img-popup"]}),this._imgPopupImgEl=(0,n.dom)("img",{attrs:{alt:""}}),this._imgPopupEl.appendChild(this._imgPopupImgEl),this.el.appendChild(this._imgPopupEl),e.appendChild(t),e.appendChild(d),this.body.appendChild(e),this._statusEl=(0,n.dom)("div",{classes:["av-status"],text:"Loading…"}),this.body.appendChild(this._statusEl)}async _loadListing(){if(this.archiveKey)try{const e=await fetch(`/api/v1/archive/${this.archiveKey}/ls`,{credentials:"same-origin"});if(!e.ok){const t=await e.json().catch(()=>({}));throw new Error(t.error||`HTTP ${e.status}`)}const t=await e.json();this._format=t.format||"?",this._allFiles=(t.files||[]).filter(e=>!e.isDir),this._tree=function(e){const t={name:"",fullPath:"",children:new Map,files:[]};for(const s of e){if(s.isDir)continue;const e=s.path.split("/");let i=t;for(let t=0;t<e.length-1;t++){const s=e[t];if(s){if(!i.children.has(s)){const e=i.fullPath?`${i.fullPath}/${s}`:s;i.children.set(s,{name:s,fullPath:e,children:new Map,files:[]})}i=i.children.get(s)}}i.files.push(s)}for(const s of e){if(!s.isDir)continue;const e=s.path.replace(/\/$/,"");if(!e)continue;const i=e.split("/").filter(Boolean);let l=t;for(const e of i){if(!l.children.has(e)){const t=l.fullPath?`${l.fullPath}/${e}`:e;l.children.set(e,{name:e,fullPath:t,children:new Map,files:[]})}l=l.children.get(e)}}return t}(t.files||[]),this._setStatus(""),this._renderTree(),this._renderFiles()}catch(e){this._setStatus(`Failed to load archive: ${e.message}`)}else this._setStatus("Could not determine archive key.")}_setStatus(e){this._statusEl&&(this._statusEl.textContent=e,this._statusEl.classList.toggle("hidden",!e))}_renderTree(){if(this._treeEl.textContent="",this._tree){for(const e of this._tree.children.values())this._treeEl.appendChild(this._buildTreeNode(e,0));this._syncRootCheckbox(),this._updateFolderInfo()}}_buildTreeNode(e,t){const s=document.createDocumentFragment();if(s.appendChild(this._makeTreeRow(e,t)),this._folderExpanded.get(e.fullPath))for(const i of e.children.values())s.appendChild(this._buildTreeNode(i,t+1));return s}_makeTreeRow(e,t=0){const s=e.fullPath,i=!!this._folderChecked.get(s),l=!!this._folderExpanded.get(s),o=e.children.size>0,a=(0,n.dom)("div",{classes:["av-tree-item",...i?["is-checked"]:[]]});a.style.paddingLeft=14*t+4+"px";const d=(0,n.dom)("input",{attrs:{type:"checkbox"},classes:["av-tree-cb"]});d.checked=i,d.addEventListener("change",()=>{this._setChildFolders(e,d.checked),a.classList.toggle("is-checked",d.checked),this._syncRootCheckbox(),this._updateFolderInfo(),this._renderFiles()});const r=(0,n.dom)("button",{classes:["av-tree-expander",...o?[]:["av-tree-expander-leaf"]],attrs:{type:"button","aria-label":l?"Collapse":"Expand"},text:o?l?"▾":"▸":" "});r.addEventListener("click",e=>{if((0,n.nukeEvent)(e),!o)return;const t=!this._folderExpanded.get(s);this._folderExpanded.set(s,t),this._renderTree()});const c=(0,n.dom)("span",{classes:["av-tree-icon","i-archive-b"]}),p=(0,n.dom)("span",{classes:["av-tree-name"],text:e.name});p.addEventListener("click",()=>{d.click()});const f=h(e).length,_=(0,n.dom)("span",{classes:["av-tree-count"],text:f>0?`${f}`:""});return a.appendChild(d),a.appendChild(r),a.appendChild(c),a.appendChild(p),a.appendChild(_),a}_setChildFolders(e,t){this._folderChecked.set(e.fullPath,t);for(const s of e.children.values())this._setChildFolders(s,t)}_syncRootCheckbox(){if(!this._rootCbEl)return;const e=!!this._folderChecked.get("");if(this._rootCbEl.checked=e,this._rootCbEl.indeterminate=!1,!e)for(const[e,t]of this._folderChecked)if(""!==e&&t){this._rootCbEl.indeterminate=!0;break}}_makeFilePanelFolderRow(e){const t=e.fullPath,s=!!this._folderChecked.get(t),i=h(e).length,l=(0,n.dom)("div",{classes:["av-file-item","av-file-folder",...s?["is-checked"]:[]]}),o=(0,n.dom)("input",{attrs:{type:"checkbox"},classes:["av-file-cb"]});o.checked=s,o.addEventListener("change",()=>{this._setChildFolders(e,o.checked),this._syncRootCheckbox(),this._updateFolderInfo(),this._renderTree(),this._renderFiles()});const a=(0,n.dom)("span",{classes:["av-file-name"],attrs:{title:t}});a.textContent=e.name+"/",a.addEventListener("click",()=>o.click());const d=(0,n.dom)("span",{classes:["av-file-size"],text:i>0?`${i} file${1===i?"":"s"}`:""});return l.appendChild(o),l.appendChild(a),l.appendChild(d),l}_getVisibleFiles(){if(!this._tree)return[];let e;if(!!this._folderChecked.get(""))e=this._allFiles;else{const t=[],s=new Set,i=e=>{if(this._folderChecked.get(e.fullPath))for(const i of h(e))s.has(i.path)||(s.add(i.path),t.push(i));else for(const t of e.children.values())i(t)};i(this._tree),e=t.length||this._hasAnyFolderChecked()?t:this._allFiles}const t=this._searchQuery;return t?e.filter(e=>(e.path.split("/").pop()||e.path).toLowerCase().includes(t)||e.path.toLowerCase().includes(t)):e}_hasAnyFolderChecked(){for(const e of this._folderChecked.values())if(e)return!0;return!1}_renderFiles(){if(this._fileListEl.textContent="",this._tree&&this._tree.children.size>0)for(const e of this._tree.children.values())this._fileListEl.appendChild(this._makeFilePanelFolderRow(e));const e=this._getVisibleFiles();if(!e.length){if(!this._tree||0===this._tree.children.size){const e=(0,n.dom)("div",{classes:["av-files-empty"],text:this._tree?"No files in selection.":"Loading…"});this._fileListEl.appendChild(e)}return this._updateFileInfo(),void this._updateDownloadBtn()}for(const t of e){const e=(0,n.dom)("div",{classes:["av-file-item"]}),s=(0,n.dom)("input",{attrs:{type:"checkbox"},classes:["av-file-cb"]});s.checked=!!this._fileChecked.get(t.path),s.addEventListener("change",()=>{this._fileChecked.set(t.path,s.checked),e.classList.toggle("is-checked",s.checked),this._updateFileInfo(),this._updateDownloadBtn()});const i=(0,n.dom)("span",{classes:["av-file-name"],text:t.path.split("/").pop()||t.path,attrs:{title:t.path}});i.addEventListener("click",()=>s.click());const l=(0,n.dom)("span",{classes:["av-file-path"],text:t.path.includes("/")?t.path.slice(0,t.path.lastIndexOf("/")):"",attrs:{title:t.path}}),o=(0,n.dom)("span",{classes:["av-file-size"],text:t.size>0?(0,n.toPrettySize)(t.size):"—"});if(e.classList.toggle("is-checked",!!this._fileChecked.get(t.path)),e.appendChild(s),e.appendChild(i),e.appendChild(l),e.appendChild(o),d(t.path)&&this._imgPopupEl){const s=`/api/v1/archive/${this.archiveKey}/file?path=${encodeURIComponent(t.path)}`;e.addEventListener("mouseenter",()=>{this._imgPopupImgEl.src=s;const t=e.getBoundingClientRect(),i=this.el.getBoundingClientRect(),l=Math.max(4,Math.min(t.top-i.top-60,i.height-210));this._imgPopupEl.style.top=`${l}px`,this._imgPopupEl.style.display="block"}),e.addEventListener("mouseleave",()=>{this._imgPopupEl.style.display="none"})}this._fileListEl.appendChild(e)}this._updateFileInfo(),this._updateDownloadBtn()}_updateFolderInfo(){let e=0;for(const[t,s]of this._folderChecked)""!==t&&s&&e++;this._folderInfoEl&&(this._folderInfoEl.textContent=e>0?`${e} folder${1===e?"":"s"} selected`:"")}_updateFileInfo(){let e=0;for(const t of this._fileChecked.values())t&&e++;const t=this._getVisibleFiles().length;this._fileInfoEl&&(this._fileInfoEl.textContent=`${t} file${1===t?"":"s"}`+(e>0?` · ${e} selected`:""))}_updateDownloadBtn(){if(!this._dlBtn)return;const e=this._selectedDownloadFiles().length;this._dlBtn.textContent=e>0?`Download ${e} File${1===e?"":"s"}`:"Download Selected",this._dlBtn.disabled=0===e}_selectAllFiles(e){const t=this._getVisibleFiles();for(const s of t)this._fileChecked.set(s.path,e);this._renderFiles()}_expandAll(e){if(!this._tree)return;const t=s=>{s.children.size>0&&this._folderExpanded.set(s.fullPath,e);for(const e of s.children.values())t(e)};t(this._tree),this._renderTree()}_selectedDownloadFiles(){if(!this.archiveKey)return[];const e=this._getVisibleFiles(),t=e.filter(e=>this._fileChecked.get(e.path));return(t.length>0?t:e).map(e=>({key:`archive:${this.archiveKey}:${e.path}`,name:e.path.split("/").pop()||e.path,url:`/api/v1/archive/${this.archiveKey}/file?path=${encodeURIComponent(e.path)}`,size:e.size,expired:!1,meta:{}}))}async onclick(e,t){if((0,n.nukeEvent)(t),e.cancel||"close"===e.id)return this._unmount(),void this.reject(new Error("cancelled"));if("download"===e.id){const e=this._selectedDownloadFiles();if(!e.length)return;this._showDownloadIn(e)}}async _showDownloadIn(e){if(this._subHolder||!this._holder)return;const t=`Download from ${this.fileInst.name}`,s=l.A.files.getDownloadPrefs(),i=new o.A(t,e.length,{skipExisting:s.skipExisting,retries:s.maxRetries,concurrent:s.maxConcurrent,onOptionsChange:e=>l.A.files.saveDownloadPrefs(e)});this._subHolder=(0,n.dom)("div",{classes:["av-sub-holder"]}),this._subHolder.appendChild(i.el),this._holder.appendChild(this._subHolder),i.onshown();const a=i.promise.catch(()=>{});let d;try{d=await i.waitForStart(),l.A.files.saveDownloadPrefs(d)}catch{return i.cancelRequested=!0,await a,void this._removeSubHolder()}const h=Math.max(0,Math.min(5,Number(d.maxRetries)||0)),r=Math.max(1,Math.min(4,Number(d.maxConcurrent)||4));let c=0,p=0,f=0;const _=e.length;await Promise.all(Array.from({length:r},async()=>{for(;;){if(i.cancelRequested)return;const t=f++;if(t>=_)return;const s=e[t];if(i.setCurrent(`Downloading: ${s.name}`),i.skipExisting&&l.A.files.hasDownloadedFilename(s.name)){i.upsertFileStatus(s.name,"skipped",1,"existing filename"),i.update(c,p,0);continue}let n=!1,o=null;for(let e=1;e<=h+1;e++){i.upsertFileStatus(s.name,1===e?"running":"retrying",e);try{await l.A.files.fetchAndTriggerDownload(s),c++,n=!0,l.A.files.markFilenameDownloaded(s.name),i.upsertFileStatus(s.name,"success",e);break}catch(e){o=e}}n||(p++,i.upsertFileStatus(s.name,"failed",h+1,o&&o.message||"failed")),i.update(c,p,0)}})),i.cancelRequested||i.finish(c,p,0,!1),await a,this._removeSubHolder()}_removeSubHolder(){this._subHolder&&this._subHolder.parentElement&&this._subHolder.parentElement.removeChild(this._subHolder),this._subHolder=null}}}}]);
//# sourceMappingURL=archivemodal.js.map?v=80a5b0a72bf110b50b7f